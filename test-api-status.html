<!DOCTYPE html>
<html>
<head>
    <title>Test Status Update</title>
</head>
<body>
    <h1>Teste de Atualização de Status</h1>
    <button onclick="testStatus()">Testar Status Retirado</button>
    <div id="result"></div>

    <script>
    async function testStatus() {
        const resultDiv = document.getElementById('result');
        
        try {
            // Pegar token do localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                resultDiv.innerHTML = '<p style="color: red;">Erro: Token não encontrado no localStorage</p>';
                return;
            }
            
            // Primeiro, buscar pedidos
            const ordersResponse = await fetch('http://localhost:3001/api/orders', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!ordersResponse.ok) {
                throw new Error('Erro ao buscar pedidos: ' + ordersResponse.status);
            }
            
            const ordersData = await ordersResponse.json();
            console.log('Pedidos:', ordersData);
            
            if (!ordersData.orders || ordersData.orders.length === 0) {
                resultDiv.innerHTML = '<p style="color: orange;">Nenhum pedido encontrado</p>';
                return;
            }
            
            const orderId = ordersData.orders[0].id;
            resultDiv.innerHTML += `<p>Usando pedido ID: ${orderId}</p>`;
            
            // Tentar atualizar para "retirado"
            const updateResponse = await fetch(`http://localhost:3001/api/orders/${orderId}/status`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status_pedido: 'retirado' })
            });
            
            const responseText = await updateResponse.text();
            console.log('Response status:', updateResponse.status);
            console.log('Response text:', responseText);
            
            if (updateResponse.ok) {
                resultDiv.innerHTML += '<p style="color: green;">✅ Status atualizado com sucesso!</p>';
                resultDiv.innerHTML += `<pre>${responseText}</pre>`;
            } else {
                resultDiv.innerHTML += `<p style="color: red;">❌ Erro ${updateResponse.status}</p>`;
                resultDiv.innerHTML += `<pre>${responseText}</pre>`;
                
                // Tentar parsear erro
                try {
                    const errorData = JSON.parse(responseText);
                    console.error('Erro detalhado:', errorData);
                } catch (e) {
                    console.error('Resposta não é JSON:', responseText);
                }
            }
            
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
            console.error('Erro completo:', error);
        }
    }
    </script>
</body>
</html>